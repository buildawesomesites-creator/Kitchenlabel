<!DOCTYPE html>
<html lang="vi" translate="no" class="notranslate">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google" content="notranslate">
<meta http-equiv="Content-Language" content="vi">
<title>KOT Print (Browser)</title>
<style>
  @page { size: 80mm auto; margin: 3mm; }
  body { font-family: Arial, Helvetica, sans-serif; width: 80mm; margin: 0 auto; font-size: 14px; background: #fff; }
  .receipt { width: 100%; }
  .copy { text-align: left; font-weight: bold; margin-bottom: 3px; }
  h2 { text-align: center; margin: 2px 0 5px 0; font-weight: 900; font-size: 18px; }
  .meta { font-size: 14px; margin: 1px 0; display: flex; align-items: center; gap: 4px; }
  .meta b { font-weight: bold; min-width: auto; }
  .code-line { font-size: 13px; margin: 4px 0 6px 0; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 4px 0; text-align: left; border-bottom: 1px solid #000; font-size: 14px; }
  th { font-weight: bold; }

  /* Buttons */
  .no-print button {
    background: #0066ff;
    color: #fff;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    margin-top: 8px;
    cursor: pointer;
    font-weight: bold;
  }
  .no-print button:hover { background: #004bb5; }

  /* Hide buttons in print */
  @media print { .no-print { display: none !important; } }

  /* Preview Modal */
  #previewModal {
    display: none;
    position: fixed;
    z-index: 1000;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    overflow-y: auto;
    padding: 20px;
  }
  #previewContent {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    margin: auto;
  }
  #previewImg { width: 90%; border: 1px solid #ddd; border-radius: 6px; }
  #closeModalBtn { background: #dc3545; margin-top: 10px; }
  #closeModalBtn:hover { background: #b02a37; }
</style>
</head>
<body>

<div class="receipt" id="receipt">
  <div class="copy">Copies 1</div>
  <h2>CH·∫æ BI·∫æN</h2>

  <div class="meta"><b>B√†n:</b><span id="tableNum">‚Äî</span></div>
  <div class="meta"><b>Ph·ª•c v·ª•:</b><span id="serverName">Qu·ª≥nh Anh</span></div>
  <div class="code-line" id="codeLine"></div>

  <table>
    <thead>
      <tr><th>M√≥n</th><th>DVT</th><th>SL</th></tr>
    </thead>
    <tbody id="itemList">
      <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
    </tbody>
  </table>
</div>

<div class="no-print" style="text-align:center;">
  <button id="normalPrintBtn">üñ®Ô∏è Normal Print</button>
  <button id="previewBtn">üîç Print Preview</button>
  <button id="wifiPrintBtn">üì° Wi-Fi Print</button>
</div>

<!-- Preview Modal -->
<div id="previewModal">
  <div id="previewContent">
    <h4>üñºÔ∏è KOT Print Preview</h4>
    <img id="previewImg" alt="KOT Preview">
    <br>
    <button id="closeModalBtn" onclick="closeModal()">‚úñ Close</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // Random service code + date/time
  function randomCode() {
    const p1 = Math.floor(Math.random() * 90 + 10);
    const p2 = Math.floor(Math.random() * 90 + 10);
    return `${p1}-${p2}`;
  }

  const now = new Date();
  const date = now.toLocaleDateString('en-GB');
  const time = now.toLocaleTimeString('en-GB', { hour12: false });
  document.getElementById('codeLine').textContent = `${randomCode()}  ${time}  ${date}`;

  // Get data
  const params = new URLSearchParams(window.location.search);
  let table = params.get("table");
  let itemsData = params.get("items");
  let items = [];

  if (!itemsData) {
    const saved = localStorage.getItem("papadumsInvoiceData");
    if (saved) { try { const parsed = JSON.parse(saved); table = parsed.table||table; items = parsed.items||[]; } catch(e){console.warn(e);} }
  } else { try{ items = JSON.parse(decodeURIComponent(itemsData)); } catch(e){console.warn(e);} }

  document.getElementById("tableNum").textContent = (table||"‚Äî").replace(/table\s*/i,"");

  // Render items
  const tbody = document.getElementById("itemList");
  tbody.innerHTML = "";
  if (!items || items.length===0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="3" style="text-align:center;">Kh√¥ng c√≥ m√≥n</td>`;
    tbody.appendChild(tr);
  } else {
    items.forEach(it=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${it.name}</td><td>${it.unit||""}</td><td>${it.qty}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Modal functions
  async function showPreview() {
    const receipt = document.getElementById("receipt");

    // Wait for all images inside receipt (like logos, QR)
    const imgs = receipt.querySelectorAll("img");
    await Promise.all(Array.from(imgs).map(img => {
      if (img.complete) return Promise.resolve();
      return new Promise(res=>{ img.onload=img.onerror=res; });
    }));

    const canvas = await html2canvas(receipt,{scale:2,backgroundColor:"#ffffff"});
    const dataUrl = canvas.toDataURL("image/png");
    localStorage.setItem("lastKOTPNG", dataUrl);
    document.getElementById("previewImg").src = dataUrl;
    document.getElementById("previewModal").style.display = "flex";
    return dataUrl;
  }

  function closeModal() { document.getElementById("previewModal").style.display="none"; }

  // Normal Print
  document.getElementById("normalPrintBtn").addEventListener("click",()=>{ window.print(); });

  // Preview Modal
  document.getElementById("previewBtn").addEventListener("click", showPreview);

  // Wi-Fi Print
  document.getElementById("wifiPrintBtn").addEventListener("click", async()=>{
    const dataUrl = localStorage.getItem("lastKOTPNG");
    if(!dataUrl){ alert("‚ö†Ô∏è Please generate preview first"); return; }

    const printerIp = localStorage.getItem("printerIp_kitchen")||localStorage.getItem("printerIp");
    if(!printerIp){ console.log("‚ö†Ô∏è No kitchen printer IP, fallback to browser print."); window.print(); return; }

    try {
      const order={table,items,type:"KOT",image:dataUrl};
      const resp=await fetch(`http://${printerIp}/print`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(order)
      });
      console.log("‚úÖ Sent KOT to Wi-Fi printer:",resp.status);
    } catch(err){ console.error("‚ùå Wi-Fi printer failed:",err); window.print(); }
  });

  // Auto silent print for native app
  if(navigator.userAgent.includes("PapadumsPOSApp")){
    showPreview().then(()=>document.getElementById("wifiPrintBtn").click());
  }

</script>
</body>
</html>
