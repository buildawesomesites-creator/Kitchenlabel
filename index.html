<!doctype html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Papadums POS V.1</title>

  <style>
  :root {
    --blue1:#0b74ff;
    --blue2:#0062cc;
    --bg:#f5f8ff;
    --card:#fff;
    --danger:#e55353;
    --shadow:0 6px 18px rgba(3,20,66,0.06);
  }
  html,body {
    height:100%;margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    background:var(--bg);color:#111;
    -webkit-font-smoothing:antialiased;
    overflow:hidden;
    overscroll-behavior:contain;
    touch-action: manipulation;
  }
  button { -webkit-tap-highlight-color: transparent; }

  header {
    margin:10px;border-radius:10px;
    background:linear-gradient(90deg,var(--blue1),var(--blue2));
    color:#fff;text-align:center;padding:12px;
    font-weight:800;font-size:18px;box-shadow:var(--shadow);
    position:relative;display:flex;align-items:center;justify-content:center;gap:6px;
  }
  #versionTag {
    position:absolute;left:14px;background:#fff;color:var(--blue2);
    font-weight:800;padding:2px 8px;border-radius:8px;font-size:13px;
  }
  #syncStatus {
    position:absolute;right:12px;top:10px;
    background:#fff3;padding:4px 10px;border-radius:8px;
    font-size:13px;font-weight:600;color:#fff;
    transition:all 0.3s ease;
  }
  #syncStatus.online{background:#00b86b;}
  #syncStatus.offline{background:#e55353;}
  #syncStatus.syncing{background:#ffb400;}
  #printerDot {
    width:10px;height:10px;border-radius:50%;
    background:red;display:inline-block;margin-left:6px;
    box-shadow:0 0 4px #0003;
  }
  @keyframes blink {0%{opacity:1;}50%{opacity:0.3;}100%{opacity:1;}}
  .blinking { animation: blink 1s infinite; }

  .wrap{display:flex;flex-direction:column;gap:10px;padding:8px;box-sizing:border-box;}
  .table-panel{background:var(--card);border-radius:12px;padding:8px;box-shadow:var(--shadow);}
  .table-panel h3{margin:6px 0;text-align:center;color:var(--blue2);font-size:15px;font-weight:700;}
  .tables{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
  .table-card{
    background:linear-gradient(180deg,#fff,#f6fbff);
    border:1px solid #dfecff;border-radius:8px;height:52px;
    display:flex;justify-content:center;align-items:center;
    cursor:pointer;font-weight:800;color:#0a4fd8;user-select:none;
  }
  .table-card.active{
    background:linear-gradient(90deg,var(--blue1),var(--blue2));
    color:#fff;box-shadow:0 6px 18px rgba(11,116,255,0.14);
  }

  .controls-panel{background:var(--card);border-radius:12px;padding:10px;box-shadow:var(--shadow);}
  .top-row{display:flex;gap:8px;margin-bottom:8px;position:relative;}
  .bottom-row{display:flex;gap:8px;}
  #productSearch{flex:0 0 70%;}

  #qty {flex:0 0 15%;text-align:center;font-size:14px;padding:6px 8px;border-radius:8px;box-sizing:border-box;}

  .btn-add{
    flex:0 0 70%;background:linear-gradient(90deg,var(--blue1),var(--blue2));
    color:#fff;border:none;padding:10px 14px;border-radius:10px;
    font-weight:800;font-size:15px;cursor:pointer;
  }
  .btn-clear{
    flex:0 0 20%;background:var(--danger);color:#fff;
    border:none;border-radius:10px;padding:10px;font-weight:800;cursor:pointer;
  }
  .controls-panel input[type="text"],
  .controls-panel input[type="number"]{
    border:1px solid #e6eefc;border-radius:10px;padding:6px 8px;font-size:14px;background:#fff;
    box-sizing:border-box;
  }

  /* Hide native datalist on mobile */
  @media screen and (max-width: 768px) { datalist { display: none; } }

  #productDropdown {
    position:absolute;top:38px;left:0;right:0;
    background:#fff;border:1px solid #e6eefc;border-radius:10px;
    max-height:180px;overflow-y:auto;display:none;z-index:1000;
  }
  #productDropdown div { padding:10px; cursor:pointer; }
  #productDropdown div:hover { background:var(--blue1); color:#fff; }

  .preview-panel{
    background:var(--card);border-radius:12px;box-shadow:var(--shadow);
    display:flex;flex-direction:column;cursor:pointer;
  }
  .preview-panel:hover{box-shadow:0 0 0 2px var(--blue1) inset;}
  .preview-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #f0f4ff;flex-shrink:0;}
  .preview-header h3{margin:0;color:var(--blue2);font-size:16px;font-weight:800;}
  .preview-body{padding:10px;overflow-y:auto;max-height:60vh;-webkit-overflow-scrolling:touch;flex:1 1 auto;}
  .item-row{display:flex;justify-content:space-between;align-items:center;background:#f9fbff;border:1px solid #f0f6ff;border-radius:8px;padding:10px;margin-bottom:8px;}
  .item-left{font-size:15px;font-weight:700;max-width:45%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .item-right{display:flex;align-items:center;gap:8px;font-size:14px;}
  .qty-btn{background:linear-gradient(90deg,var(--blue1),var(--blue2));color:#fff;border:none;border-radius:8px;padding:8px 10px;font-weight:800;cursor:pointer;min-width:36px;}
  .remove-btn{background:var(--danger);color:#fff;border:none;border-radius:8px;padding:8px 10px;font-weight:800;cursor:pointer;}
  .price-amount{font-weight:800;min-width:72px;text-align:right;}
  .totals-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-top:1px dashed #eee;font-weight:800;font-size:16px;flex-shrink:0;background:#fff;position:sticky;bottom:0;z-index:5;box-shadow:0 -3px 8px rgba(0,0,0,0.04);}

  .footer-fixed{position:fixed;left:8px;right:8px;bottom:env(safe-area-inset-bottom,10px);z-index:999;display:flex;justify-content:center;}
  .footer-inner{width:100%;max-width:980px;background:var(--card);border-radius:12px;box-shadow:var(--shadow);display:flex;flex-wrap:wrap;gap:8px;padding:10px;box-sizing:border-box;justify-content:center;}
  .footer-btn{flex:1 1 40%;border:none;padding:12px;border-radius:10px;font-weight:900;font-size:15px;color:#fff;cursor:pointer;min-width:120px;}
  .footer-btn.kot{background:linear-gradient(90deg,var(--blue1),var(--blue2));}
  .footer-btn.inv{background:linear-gradient(90deg,#ff8a3d,#ff6a00);}

  #fullPreviewModal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:2000;}
  #fullPreviewBox{background:#fff;width:95%;max-width:450px;max-height:90vh;overflow-y:auto;border-radius:12px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,0.25);animation: fadeIn 0.2s ease;}
  @keyframes fadeIn { from{opacity:0;transform:scale(0.95);} to{opacity:1;transform:scale(1);} }
  #closePreview{position:absolute;top:12px;right:18px;font-size:26px;font-weight:bold;color:#555;cursor:pointer;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="table-panel">
    <h3>Tables</h3>
    <div class="tables" id="tablesContainer">
      <div class="table-card active" data-table="table1"><strong>1</strong></div>
      <div class="table-card" data-table="table2"><strong>2</strong></div>
      <div class="table-card" data-table="table3"><strong>3</strong></div>
      <div class="table-card" data-table="takeaway"><strong>Takeaway</strong></div>
      <div class="table-card" data-table="online"><strong>Online</strong></div>
    </div>
  </div>

  <div class="controls-panel">
    <div class="top-row">
      <input id="productSearch" type="text" list="productList" placeholder="Search product..." autocomplete="off" />
      <datalist id="productList"></datalist>
      <div id="productDropdown"></div>
      <input id="qty" type="number" min="1" value="1" />
    </div>
    <div class="bottom-row">
      <button id="clearBtn" class="btn-clear">Clear Items</button>
      <button id="addBtn" class="btn-add">Add Item</button>
    </div>
  </div>

  <div class="preview-panel" id="previewPanel">
    <div class="preview-header">
      <h3>Order Preview</h3>
      <small id="previewInfo">Table 1</small>
    </div>
    <div class="preview-body" id="previewBody">
      <div style="text-align:center;color:#777;padding:18px">No items</div>
    </div>
    <div class="totals-row">
      <div>Total</div>
      <div id="totalDisplay">0₫</div>
    </div>
  </div>
</div>

<div class="footer-fixed">
  <div class="footer-inner">
    <button id="printKOT" class="footer-btn kot">Print KOT</button>
    <button id="printInv" class="footer-btn inv">Print Invoice</button>
    <input id="printerIp" type="text" placeholder="Printer IP" style="flex:0 0 180px;border:1px solid #e6eefc;border-radius:10px;padding:0 10px;font-size:15px;outline:none;" />
  </div>
</div>

<div id="fullPreviewModal">
  <div id="fullPreviewBox">
    <span id="closePreview">&times;</span>
    <div id="fullPreviewContent"></div>
  </div>
</div>

<script type="module" src="./index_function.online.js"></script>

<script>
  // === Format Number ===
  function formatNumber(num){
    if(isNaN(num)) return num;
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");
  }

  // === Printer Connection ===
  const ipInput = document.getElementById("printerIp");
  const savedIp = localStorage.getItem("printerIp");
  if(savedIp) ipInput.value = savedIp;
  const dot = document.getElementById("printerDot");

  async function checkPrinterConnection(){
    const ip = localStorage.getItem("printerIp");
    if(!ip){ dot.style.background="gray"; dot.classList.remove("blinking"); return; }
    dot.style.background="yellow"; dot.classList.add("blinking");
    try{ await fetch(`http://${ip}:9100`,{mode:"no-cors"}); dot.style.background="limegreen"; }
    catch{ dot.style.background="red"; }
    finally{ dot.classList.remove("blinking"); }
  }
  ipInput.addEventListener("input",()=>{ localStorage.setItem("printerIp",ipInput.value); checkPrinterConnection(); });
  checkPrinterConnection(); setInterval(checkPrinterConnection,10000);

  // === Clickable Order Preview ===
  const previewPanel = document.getElementById("previewPanel");
  const fullModal = document.getElementById("fullPreviewModal");
  const fullContent = document.getElementById("fullPreviewContent");
  const closeBtn = document.getElementById("closePreview");
  previewPanel.addEventListener("click",()=>{
    fullContent.innerHTML = document.getElementById("previewBody").innerHTML +
      `<div style='padding:12px;font-weight:800;text-align:right;border-top:1px solid #eee;margin-top:10px;'>Total: ${document.getElementById("totalDisplay").textContent}</div>`;
    fullModal.style.display="flex";
  });
  closeBtn.onclick=()=>fullModal.style.display="none";
  fullModal.addEventListener("click",(e)=>{if(e.target===fullModal)fullModal.style.display="none";});

  // === Product Search + Custom Dropdown + Add to Cart + Clear Input ===
  const searchInput = document.getElementById("productSearch");
  const dropdown = document.getElementById("productDropdown");

  function addProductToCart(productName){
    console.log("Added to cart:", productName);
    // Add your logic to update previewBody and totalDisplay here
  }

  searchInput.addEventListener("input",()=>{
    const value = searchInput.value.toLowerCase();
    const options = Array.from(document.getElementById("productList").options);
    dropdown.innerHTML = "";
    const filtered = options.filter(o=>o.value.toLowerCase().includes(value));
    filtered.forEach(o=>{
      const div = document.createElement("div");
      div.textContent = o.value;
      div.onclick=()=>{
        addProductToCart(o.value);
        searchInput.value="";
        document.getElementById("qty").value=1;
        dropdown.style.display="none";
      };
      dropdown.appendChild(div);
    });
    dropdown.style.display = filtered.length ? "block":"none";
  });

  document.addEventListener("click", e=>{
    if(!searchInput.contains(e.target) && !dropdown.contains(e.target))
      dropdown.style.display="none";
  });

  // === Remove native datalist on mobile ===
  if(window.innerWidth <= 768){
    searchInput.removeAttribute("list");
  }
</script>

<script>
  // ✅ Register Service Worker for Offline + Auto Update
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => {
          console.log('✅ Service Worker registered:', reg.scope);

          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW.addEventListener('statechange', () => {
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('🔄 New content available — refresh page to update');
                newSW.postMessage({ type: 'SKIP_WAITING' });
              }
            });
          });
        })
        .catch(err => console.error('❌ Service Worker registration failed:', err));

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('⚡ New Service Worker controlling page — reload now');
        window.location.reload();
      });
    });
  }
</script>

</body>
</html>
