<!DOCTYPE html>
<html lang="vi" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="google" content="notranslate">
<title>Kitchenlabel</title>
<meta name="theme-color" content="#ffffff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="manifest" href="./manifest.json">

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100dvh; /* ‚úÖ Use full visible screen height */
    background: #fff;
    color: #000;
    font-family: "Helvetica Neue","Noto Sans","Roboto",Arial,sans-serif;
    font-size: 13px; /* ‚úÖ Slightly larger for real app feel */
    overscroll-behavior: none;
    overflow: hidden; /* ‚úÖ No global scroll */
    touch-action: none; /* Disable global gestures */
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-text-size-adjust: none;
    user-select: none;
    position: fixed;
    inset: 0;
  }

  body {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    overflow: hidden;
  }

  .content {
    flex: 1;
    padding: 8px;
    overflow-y: auto; /* ‚úÖ Only this scrolls */
    -webkit-overflow-scrolling: touch;
    box-sizing: border-box;
    scrollbar-width: none;
  }

  .content::-webkit-scrollbar { display: none; }

  .copies { font-size: 11px; margin-bottom: 2px; text-align: left; }
  .center { text-align: center; }
  .title { font-weight: 700; font-size: 16px; margin: 4px 0 6px 0; }
  .info { margin: 0 0 8px 0; font-size: 12px; }
  .info em { color: #555; font-style: normal; display: block; margin-top: 4px; }
  hr { border: none; border-top: 1px solid #000; margin: 6px 0; }
  table { width: 100%; border-collapse: collapse; }
  td { padding: 3px 0; vertical-align: top; font-size: 13px; }
  .code { font-size: 10px; color: #666; }
  .qty-input { width: 36px; font-size: 12px; border: 1px solid #ccc; border-radius: 3px; text-align: right; margin-left: 4px; }
  .no-print { margin-top: 8px; text-align: center; }
  button {
    font-size: 13px;
    padding: 6px 8px;
    margin: 2px;
    border: none;
    background: #f2f2f2;
    border-radius: 6px;
  }
  button:active { background: #ddd; }
  #installAppBtn {
    display: none;
    background: #ff7a00;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    margin-top: 6px;
  }

  @media print {
    .no-print { display: none!important; }
    body { margin: 0; padding: 0; width: 80mm; }
  }
</style>
</head>
<body>
  <div class="content">
    <div class="copies">Copies 1</div>
    <div class="center title">CH·∫æ BI·∫æN</div>

    <p class="info">
      <strong>B√†n:</strong> B√ÄN 3<br>
      <strong>Ph·ª•c v·ª•:</strong> Qu·ª≥nh Anh
      <em id="datetime"></em>
    </p>

    <hr>

    <table>
      <thead>
        <tr style="font-weight:600;">
          <td>M√≥n</td>
          <td style="text-align:right; width:18mm;">ƒêVT</td>
          <td style="text-align:right; width:12mm;">SL</td>
          <td></td>
        </tr>
      </thead>
      <tbody id="productList"></tbody>
    </table>

    <hr>

    <div class="no-print">
      <input type="text" id="searchProduct" placeholder="Search product..." list="productListData">
      <datalist id="productListData"></datalist><br>
      <button onclick="addSelectedProduct()">Add</button>
      <button onclick="clearProducts()">Clear All</button>
      <button onclick="printReceipt()">Print</button>
      <button onclick="downloadReceipt()">Download</button><br>
      <button id="installAppBtn">üì≤ C√†i ƒë·∫∑t ·ª©ng d·ª•ng</button>
    </div>
  </div>

<script>
/* ---------- Install Prompt ---------- */
let deferredPrompt;
const installBtn = document.getElementById('installAppBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
  console.log('‚úÖ beforeinstallprompt fired');
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  console.log('User choice:', choice.outcome);
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

/* ---------- Service Worker ---------- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(() => console.log('‚úÖ Service Worker registered'))
    .catch(err => console.error('‚ùå SW registration failed:', err));
}

/* ---------- Product Logic ---------- */
let products = [];
let order = [];

async function loadProducts(){
  try {
    const res = await fetch('products.json?v=' + Date.now(), {cache:'no-store'});
    products = await res.json();
  } catch (e){
    console.warn('Failed to load products.json', e);
    products = [{name:'N∆∞·ªõc su·ªëi 500 ml', code:'SP000216'}];
  }
  renderAutocomplete();
}

function renderAutocomplete(){
  const dl = document.getElementById('productListData');
  dl.innerHTML = '';
  products.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.name;
    dl.appendChild(opt);
  });
}

function addSelectedProduct(){
  const v = document.getElementById('searchProduct').value.trim();
  if(!v) return;
  const f = products.find(p => p.name.toLowerCase() === v.toLowerCase());
  const code = f?.code || '';
  order.push({name:v, code, qty:1});
  document.getElementById('searchProduct').value = '';
  renderProducts();
}

function renderProducts(){
  const tbody = document.getElementById('productList');
  tbody.innerHTML = '';
  order.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(it.name)} ${it.code?`<br><span class="code">(${escapeHtml(it.code)})</span>`:''}</td>
      <td style="text-align:right;">${it.unit||''}</td>
      <td style="text-align:right;">${it.qty}</td>
      <td style="text-align:right;">
        <button class="small-btn no-print" onclick="deleteProduct(${idx})">Del</button>
        <input type="number" class="qty-input no-print" min="1" value="${it.qty}" onchange="updateQty(${idx}, this.value)">
      </td>`;
    tbody.appendChild(tr);
  });
}

function updateQty(i,v){ order[i].qty = parseInt(v)||1; renderProducts(); }
function deleteProduct(i){ order.splice(i,1); renderProducts(); }
function clearProducts(){ if(confirm('Clear all products?')){ order=[]; renderProducts(); } }

function printReceipt(){
  document.querySelectorAll('.no-print').forEach(e=>e.style.display='none');
  window.print();
  setTimeout(()=>document.querySelectorAll('.no-print').forEach(e=>e.style.display=''),700);
}

function downloadReceipt(){
  document.querySelectorAll('.no-print').forEach(e=>e.style.display='none');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:[80,210]});
  doc.setFont('Helvetica','normal');
  let y = 8;
  doc.setFontSize(9); doc.text('Copies 1',5,y); y+=5;
  doc.setFontSize(12); doc.text('CH·∫æ BI·∫æN',40,y,{align:'center'}); y+=7;
  doc.setFontSize(9); doc.text('B√†n: B√ÄN 3',5,y); y+=4;
  doc.text('Ph·ª•c v·ª•: Qu·ª≥nh Anh',5,y); y+=4;
  doc.text(document.getElementById('datetime').textContent,5,y); y+=4;
  doc.line(5,y,75,y); y+=4;
  doc.text('M√≥n',5,y); doc.text('ƒêVT',60,y); doc.text('SL',70,y); y+=3;
  doc.line(5,y,75,y); y+=3;
  order.forEach(p => { doc.text(p.name,5,y); if(p.code){ y+=3; doc.text('('+p.code+')',5,y);} doc.text(String(p.qty),70,y); y+=5; });
  doc.line(5,y,75,y);
  doc.save('phieu_che_bien.pdf');
  document.querySelectorAll('.no-print').forEach(e=>e.style.display='');
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function updateDateTime(){ const n=new Date(); const f=n.toLocaleString('vi-VN',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false}); document.getElementById('datetime').textContent=`17-84 - ${f}`; }

setInterval(updateDateTime,1000);
loadProducts();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
