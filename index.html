<!DOCTYPE html>
<html lang="vi" translate="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PapsdumskitchenUI7</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff7a00" />
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      background: #f6f6f6;
    }
    header {
      background: #ff7a00;
      color: white;
      text-align: center;
      padding: 12px;
      font-size: 22px;
      font-weight: 600;
    }
    .container {
      padding: 10px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      padding: 6px;
      text-align: left;
    }
    table th {
      border-bottom: 1px solid #ddd;
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .controls button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    .controls .print { background: #ff7a00; }
    .controls .download { background: #555; }
    .controls .clear { background: #e74c3c; }
    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 15px;
    }
    .item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    .item-row button {
      background: #ff7a00;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 16px;
    }
    .item-row .del {
      background: #e74c3c;
    }
  </style>
</head>
<body>
  <header>Kitchenlabel</header>
  <div class="container">
    <div class="card" id="receiptPreview">
      <div>Copies 1</div>
      <h2 style="text-align:center;margin:6px 0;">CHẾ BIẾN</h2>
      <div><b>Bàn:</b> <span id="previewTable">1</span></div>
      <div><b>Phục vụ:</b> <span id="previewServer">Quynh Anh</span></div>
      <div><span id="previewCode"></span></div>
      <table>
        <thead>
          <tr><th>Món</th><th>ĐVT</th><th>SL</th></tr>
        </thead>
        <tbody id="previewItems"></tbody>
      </table>
    </div>

    <label>Bàn</label>
    <input id="tableInput" value="1" placeholder="Số bàn..."/>

    <label>Phục vụ</label>
    <input id="serverInput" value="Quynh Anh" placeholder="Tên phục vụ..."/>

    <label>Tìm món</label>
    <input id="searchInput" list="productList" placeholder="Nhập món ăn..." />
    <datalist id="productList"></datalist>

    <button style="width:100%;background:#ff7a00;color:white;padding:10px;border:none;border-radius:8px;font-size:16px;margin-bottom:10px;" onclick="addItem()">Thêm</button>

    <div id="itemList"></div>

    <div class="controls">
      <button class="print" onclick="onPrint()">Print</button>
      <button class="download" onclick="downloadData()">Download</button>
      <button class="clear" onclick="clearAll()">Clear All</button>
    </div>
  </div>

  <script>
    let products = [];
    let order = [];

    async function loadProducts() {
      try {
        const res = await fetch("./products.json?v=" + Date.now());
        products = await res.json();
      } catch {
        products = [
          { name: "Water 500ml", dvt: "Chai" },
          { name: "Coca Cola", dvt: "Lon" },
          { name: "Bánh Mì", dvt: "Cái" }
        ];
      }
      const datalist = document.getElementById("productList");
      datalist.innerHTML = "";
      products.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.name;
        datalist.appendChild(opt);
      });
    }

    function randomCode() {
      return "HL" + Math.random().toString(36).substr(2,8).toUpperCase();
    }

    function renderPreview() {
      const tableVal = document.getElementById("tableInput").value || "";
      const serverVal = document.getElementById("serverInput").value || "";
      document.getElementById("previewTable").textContent = tableVal;
      document.getElementById("previewServer").textContent = serverVal;

      const code = randomCode();
      document.getElementById("previewCode").textContent =
        code + " - " + new Date().toLocaleString("vi-VN");

      const tbody = document.getElementById("previewItems");
      tbody.innerHTML = order.map((item, i) =>
        `<tr><td>${item.name}</td><td>${item.dvt || ""}</td><td>${item.qty}</td></tr>`
      ).join("");

      const list = document.getElementById("itemList");
      list.innerHTML = order.map((item, i) => `
        <div class="item-row">
          <span>${item.name}</span>
          <div>
            <button onclick="dec(${i})">-</button>
            <span>${item.qty}</span>
            <button onclick="inc(${i})">+</button>
            <button class="del" onclick="del(${i})">Del</button>
          </div>
        </div>
      `).join("");
    }

    function addItem() {
      const name = document.getElementById("searchInput").value.trim();
      if (!name) return;
      const existing = order.find(i => i.name === name);
      if (existing) existing.qty++;
      else {
        const match = products.find(p => p.name.toLowerCase() === name.toLowerCase());
        order.push({ name, dvt: match?.dvt || "", qty: 1 });
      }
      document.getElementById("searchInput").value = "";
      renderPreview();
    }

    function inc(i) { order[i].qty++; renderPreview(); }
    function dec(i) { if (order[i].qty > 1) order[i].qty--; else order.splice(i, 1); renderPreview(); }
    function del(i) { order.splice(i, 1); renderPreview(); }
    function clearAll() { order = []; renderPreview(); }

    function downloadData() {
      const blob = new Blob([JSON.stringify(order, null, 2)], {type:'application/json'});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "order.json";
      a.click();
    }

    // ✅ FIXED: ensures Bàn + Phục vụ visible in print
    function onPrint() {
      if (order.length === 0) { alert("Không có món nào để in!"); return; }
      const data = {
        table: document.getElementById("tableInput").value || "-",
        server: document.getElementById("serverInput").value || "Quynh Anh",
        items: order
      };
      localStorage.setItem("printData", JSON.stringify(data));
      window.location.href = "Papsdumskitchenprint7.html";
    }

    loadProducts();
    renderPreview();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
